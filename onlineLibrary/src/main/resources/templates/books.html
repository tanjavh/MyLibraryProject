<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="#{books.title}">Sve knjige</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div th:replace="fragments/nav :: nav"></div>

<h1 th:text="#{books.heading}">Sve knjige</h1>

<!-- Dugme Dodaj knjigu samo za admina -->
<div sec:authorize="hasRole('ADMIN')">
    <a th:href="@{/books/create}"
       th:text="#{books.add}">
        ➕ Dodaj knjigu
    </a>
</div>

<div style="margin: 10px 0;">
    <span th:text="#{books.sort}">Sortiraj:</span>
    <a th:href="@{/books(sort='title')}"
       th:text="#{books.sort.title}">
        Po nazivu
    </a> |
    <a th:href="@{/books(sort='author')}"
       th:text="#{books.sort.author}">
        Po autoru
    </a>
</div>

<div class="table-wrapper">
    <table>
        <thead>
        <tr>
            <th th:text="#{books.table.title}">Naslov</th>
            <th th:text="#{books.table.author}">Autor</th>
            <th th:text="#{books.table.category}">Kategorija</th>
            <th th:text="#{books.table.year}">Godina izdavanja</th>
            <th th:text="#{books.table.actions}">Akcije</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="book : ${books}">
            <td th:text="${book.title}">Naslov</td>
            <td th:text="${book.authorName}">Autor</td>
            <td th:text="#{'category.' + ${book.category}}">Kategorija</td>
            <td th:text="${book.year}">Godina</td>

            <td>

                <!-- ================= ADMIN AKCIJE ================= -->
                <span sec:authorize="hasRole('ADMIN')">

                    <form th:if="${!book.hasActiveLoans}"
                          th:action="@{'/books/delete/' + ${book.id}}"
                          method="post"
                          style="display:inline-block;">
                        <button type="submit"
                                th:text="#{books.delete}">
                            Obriši
                        </button>
                    </form>

                    <span th:if="${book.hasActiveLoans}"
                          style="color: gray; font-style: italic; margin-left: 8px;"
                          th:text="#{books.cannotDelete}">
                        Ne može se obrisati – knjiga je pozajmljena
                    </span>
                </span>

                <!-- ================= USER AKCIJE ================= -->

                <span th:if="${book.available}
                        and !${currentUserBlocked}
                        and !${book.hasActiveLoans}
                        and !${book.borrowedByCurrentUser}
                        and !${maxLoansReached}">

                    <form th:action="@{'/books/borrow/' + ${book.id}}"
                          method="post"
                          style="display:inline-block;">
                        <button type="submit"
                                th:text="#{books.borrow}">
                            Pozajmi
                        </button>
                    </form>
                </span>

                <span th:if="${book.available}
                      and !${currentUserBlocked}
                      and !${book.hasActiveLoans}
                      and !${book.borrowedByCurrentUser}
                      and ${maxLoansReached}"
                      th:text="#{books.maxLoans}">
                    ❌ Već imate maksimalno 3 pozajmljene knjige
                </span>

                <span th:unless="${book.available}"
                      style="margin-left: 10px; color: gray; font-weight: bold;"
                      th:text="#{books.borrowed}">
                    Pozajmljeno
                </span>

                <span th:if="${book.available} and ${currentUserBlocked}"
                      style="margin-left: 10px; color: red; font-weight: bold;"
                      th:text="#{books.blocked}">
                    Blokiran: ne možeš pozajmiti
                </span>

            </td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>
